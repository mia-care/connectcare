{
  "integrations": [
    {
      "source": {
        "type": "jira",
        "authentication": {
          "secret": {
            "fromEnv": "JIRA_WEBHOOK_SECRET"
          }
        }
      },
      "pipelines": [
        {
          "processors": [
            {
              "type": "mapper",
              "outputEvent": {
                "event": "{{ @this }}"
              }
            }
          ],
          "sinks": [
            {
              "type": "mongo",
              "url": {
                "fromEnv": "MONGO_URL"
              },
              "collection": "raw_events",
              "insertOnly": true
            }
          ]
        },
        {
          "processors": [
            {
              "type": "filter",
              "celExpression": "eventType == 'jira:issue_created' || eventType == 'jira:issue_updated'"
            },
            {
              "type": "mapper",
              "outputEvent": {
                "id": "{{ issue.id }}",
                "key": "{{ issue.key }}",
                "title": "{{ issue.fields.summary }}",
                "priority": "{{ issue.fields.priority }}",
                "labels": "{{ issue.fields.labels }}",
                "customfield_12345": "{{ issue.fields.customfield_12345 }}",
                "assignee": "{{ issue.fields.assignee }}",
                "fixVersions": "{{ issue.fields.fixVersions }}"
              }
            }
          ],
          "sinks": [
            {
              "type": "mongo",
              "url": {
                "fromEnv": "MONGO_URL"
              },
              "collection": "events"
            }
          ]
        },
        {
          "processors": [
            {
              "type": "filter",
              "celExpression": "eventType == 'jira:version_released'"
            },
            {
              "type": "mapper",
              "outputEvent": {
                "id": "{{ version.id }}",
                "versionName": "{{ version.name }}",
                "projectId": "{{ version.projectId }}",
                "released": "{{ version.released }}"
              }
            }
          ],
          "sinks": [
            {
              "type": "mongo",
              "url": {
                "fromEnv": "MONGO_URL"
              },
              "collection": "events"
            }
          ]
        },
        {
          "processors": [
            {
              "type": "filter",
              "celExpression": "eventType == 'jira:issue_created' && issue.key == 'CAST-1'"
            },
            {
              "type": "mapper",
              "outputEvent": {
                "id": "{{ issue.id }}",
                "key": "{{ issue.key }}",
                "issueIdAsNumber": {
                  "value": "{{ issue.id }}",
                  "castTo": "number"
                },
                "priorityAsString": {
                  "value": "{{ issue.fields.priority }}",
                  "castTo": "string"
                },
                "countAsNumber": {
                  "value": "{{ issue.fields.customfield_count }}",
                  "castTo": "number"
                },
                "title": "{{ issue.fields.summary }}"
              }
            }
          ],
          "sinks": [
            {
              "type": "mongo",
              "url": {
                "fromEnv": "MONGO_URL"
              },
              "collection": "casting_test"
            }
          ]
        }
      ]
    }
  ]
}
